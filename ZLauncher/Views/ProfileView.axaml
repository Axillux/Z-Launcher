<UserControl xmlns="https://github.com/avaloniaui"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
xmlns:vm="clr-namespace:ZLauncher.ViewModels"
xmlns:wv="using:AvaloniaWebView"
x:Class="ZLauncher.Views.ProfileView"
x:DataType="vm:ProfileViewModel">

<UserControl.Styles>
    <Style Selector="Border.skinCard">
        <Setter Property="BorderBrush" Value="Transparent"/>
        <Setter Property="BorderThickness" Value="2"/>
        <Setter Property="CornerRadius" Value="8"/>
        <Setter Property="ClipToBounds" Value="True"/>
        <Setter Property="Background" Value="#1A1A1A"/>
    </Style>
    <Style Selector="Border.skinCard:pointerover">
        <Setter Property="BorderBrush" Value="#333"/>
    </Style>
    <Style Selector="Border.skinCard.selected">
        <Setter Property="BorderBrush" Value="{DynamicResource PrimaryGreen}"/>
    </Style>
</UserControl.Styles>

<Grid RowDefinitions="Auto, *" Margin="40">
    <TextBlock Text="ПРОФИЛЬ" FontSize="32" FontWeight="Bold" Foreground="White" Grid.Row="0"/>

    <StackPanel Grid.Row="1" IsVisible="{Binding IsBusy}" VerticalAlignment="Center" HorizontalAlignment="Center" ZIndex="10">
        <TextBlock Text="Обработка..." Foreground="{DynamicResource PrimaryGreen}"/>
        <ProgressBar IsIndeterminate="True" Width="200" Margin="0,10"/>
    </StackPanel>

    <!-- LOGGED OUT -->
    <Grid Grid.Row="1" IsVisible="{Binding !IsLoggedIn}" ColumnDefinitions="*, *" IsEnabled="{Binding !IsBusy}">
        <Border Grid.Column="0" Background="#1A1A1A" CornerRadius="10" Padding="30" Margin="0,0,15,0" BorderBrush="{DynamicResource PrimaryGreen}" BorderThickness="1">
            <StackPanel VerticalAlignment="Center" Spacing="20">
                <TextBlock Text="Вход Microsoft" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Foreground="White"/>
                <Button Command="{Binding LoginMicrosoftCommand}" Classes="play" HorizontalAlignment="Stretch" Margin="20,0">
                    <TextBlock Text="ВОЙТИ" FontSize="14"/>
                </Button>
            </StackPanel>
        </Border>
        <Border Grid.Column="1" Background="#1A1A1A" CornerRadius="10" Padding="30" Margin="15,0,0,0">
            <StackPanel VerticalAlignment="Center" Spacing="20">
                <TextBlock Text="Вход Offline" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Foreground="White"/>
                <TextBox Text="{Binding OfflineUsernameInput}" Watermark="Никнейм..."/>
                <Button Command="{Binding LoginOfflineCommand}" HorizontalAlignment="Stretch" Content="ВОЙТИ" Background="Transparent" BorderBrush="Gray" BorderThickness="1"/>
            </StackPanel>
        </Border>
    </Grid>

    <!-- LOGGED IN -->
    <Grid Grid.Row="1" IsVisible="{Binding IsLoggedIn}" ColumnDefinitions="300, *">
        
        <!-- LEFT: ACTIVE SKIN (3D) -->
        <StackPanel Grid.Column="0" Spacing="15" VerticalAlignment="Top">
            <Border Background="#111" BorderBrush="#333" BorderThickness="1" CornerRadius="8" Padding="10">
                <TextBlock Text="{Binding Username}" HorizontalAlignment="Center" FontSize="20" FontWeight="Bold" Foreground="White"/>
            </Border>
            
            <!-- 3D WEBVIEW -->
            <Border Height="350" Width="300" CornerRadius="8" ClipToBounds="True" Background="Transparent">
                 <!-- FIXED: Using Url property with Data URI -->
                 <wv:WebView Url="{Binding Skin3dUrl}" />
            </Border>
            
            <TextBlock Text="Тяните для вращения" Foreground="Gray" FontSize="10" HorizontalAlignment="Center"/>
        </StackPanel>

        <!-- RIGHT: SKINS LIST -->
        <StackPanel Grid.Column="1" Margin="40,0,0,0">
            <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,0,0,20">
                <TextBlock Text="Сохраненные скины" Foreground="White" FontWeight="Bold" FontSize="16"/>
                <Border Background="{DynamicResource PrimaryGreen}" CornerRadius="4" Padding="6,2">
                    <TextBlock Text="Beta" FontSize="10" FontWeight="Bold" Foreground="Black"/>
                </Border>
            </StackPanel>

            <ScrollViewer>
                <WrapPanel Orientation="Horizontal">
                    <Button Command="{Binding AddSkinCommand}" Width="120" Height="120" Background="#1A1A1A" CornerRadius="8" Margin="0,0,10,10" BorderBrush="#333" BorderThickness="1">
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <PathIcon Data="{StaticResource add_regular}" Foreground="Gray" Width="30" Height="30"/>
                            <TextBlock Text="Добавить" Foreground="Gray" Margin="0,10,0,0" FontSize="12"/>
                        </StackPanel>
                    </Button>
                    
                    <ItemsControl ItemsSource="{Binding SavedSkins}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate><WrapPanel Orientation="Horizontal"/></ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Width="120" Height="120" Margin="0,0,10,10" Padding="0" BorderThickness="0" Background="Transparent"
                                        Command="{Binding $parent[UserControl].((vm:ProfileViewModel)DataContext).SelectSkin}" 
                                        CommandParameter="{Binding}">
                                    <Border Classes="skinCard" Classes.selected="{Binding IsSelected}">
                                         <!-- FIXED: Use 'LowQuality' for pixelated look -->
                                         <Image Source="{Binding PreviewImage}" Stretch="Uniform" Margin="20" RenderOptions.BitmapInterpolationMode="LowQuality"/>
                                    </Border>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </WrapPanel>
            </ScrollViewer>
            
            <Button Command="{Binding LogoutCommand}" Content="Выйти из аккаунта" Background="#331111" Foreground="Red" HorizontalAlignment="Left" Margin="0,30,0,0"/>
        </StackPanel>
    </Grid>
</Grid>
</UserControl>
